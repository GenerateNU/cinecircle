version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.development
    environment:
      - NODE_ENV=test
      - DATABASE_URL=postgresql://devuser:devpassword@postgres:5432/devdb
      - DIRECT_URL=postgresql://devuser:devpassword@postgres:5432/devdb
      - SYNC_FROM_PRODUCTION=false
      - AWS_ACCESS_KEY_ID=dummy-access-key-id-for-ci-tests
      - AWS_SECRET_ACCESS_KEY=dummy-secret-access-key-for-ci-tests
      - AWS_REGION=dummy-region-for-ci-tests
      - AWS_BUCKET_NAME=dummy-bucket-name-for-ci-tests
      - OPENAI_API_KEY=dummy-openai-api-key-for-ci-tests
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ci_network
    command: tail -f /dev/null

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: devdb
      POSTGRES_USER: devuser
      POSTGRES_PASSWORD: devpassword
    networks:
      - ci_network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U devuser -d devdb']
      interval: 5s
      timeout: 5s
      retries: 5

networks:
  ci_network:
    driver: bridge
